<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Callbacks and Relaxation · DispersiveShallowWater.jl</title><meta name="title" content="Callbacks and Relaxation · DispersiveShallowWater.jl"/><meta property="og:title" content="Callbacks and Relaxation · DispersiveShallowWater.jl"/><meta property="twitter:title" content="Callbacks and Relaxation · DispersiveShallowWater.jl"/><meta name="description" content="Documentation for DispersiveShallowWater.jl."/><meta property="og:description" content="Documentation for DispersiveShallowWater.jl."/><meta property="twitter:description" content="Documentation for DispersiveShallowWater.jl."/><meta property="og:url" content="https://NumericalMathematics.github.io/DispersiveShallowWater.jl/stable/callbacks/"/><meta property="twitter:url" content="https://NumericalMathematics.github.io/DispersiveShallowWater.jl/stable/callbacks/"/><link rel="canonical" href="https://NumericalMathematics.github.io/DispersiveShallowWater.jl/stable/callbacks/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DispersiveShallowWater.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../basic_example/">Basic Example</a></li><li><a class="tocitem" href="../SBP_Operators/">Summation-by-Parts Operators</a></li><li><a class="tocitem" href="../dispersion/">Dispersion</a></li><li><a class="tocitem" href="../solvers/">Using Different Solvers</a></li><li class="is-active"><a class="tocitem" href>Callbacks and Relaxation</a><ul class="internal"><li><a class="tocitem" href="#Summary-Callback"><span>Summary Callback</span></a></li><li><a class="tocitem" href="#Analysis-Callback"><span>Analysis Callback</span></a></li><li><a class="tocitem" href="#Relaxation-Callback"><span>Relaxation Callback</span></a></li><li><a class="tocitem" href="#Relaxation"><span>Relaxation</span></a></li></ul></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../dingemans/">Experimental Data</a></li><li><a class="tocitem" href="../development/">Development</a></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../ref-trixibase/">TrixiBase</a></li><li><a class="tocitem" href="../ref/">DispersiveShallowWater</a></li></ul></li><li><a class="tocitem" href="../changelog/">Changelog</a></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../code_of_conduct/">Code of Conduct</a></li><li><a class="tocitem" href="../license/">License</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Callbacks and Relaxation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Callbacks and Relaxation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/NumericalMathematics/DispersiveShallowWater.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/NumericalMathematics/DispersiveShallowWater.jl/blob/main/docs/src/callbacks.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Callbacks"><a class="docs-heading-anchor" href="#Callbacks">Callbacks</a><a id="Callbacks-1"></a><a class="docs-heading-anchor-permalink" href="#Callbacks" title="Permalink"></a></h1><p>Callbacks provide additional functionality during simulations, such as monitoring solution properties, analyzing errors, or ensuring conservation of physical quantities. DispersiveShallowWater.jl implements three main callback types that can be used individually or in combination to enhance simulation analysis and performance monitoring.</p><p>When using multiple callbacks simultaneously, combine them using a <code>CallbackSet</code>:</p><pre><code class="language-julia hljs">callbacks = CallbackSet(analysis_callback, summary_callback)
sol = solve(ode, Tsit5(), callback = callbacks)</code></pre><h2 id="Summary-Callback"><a class="docs-heading-anchor" href="#Summary-Callback">Summary Callback</a><a id="Summary-Callback-1"></a><a class="docs-heading-anchor-permalink" href="#Summary-Callback" title="Permalink"></a></h2><p>The <a href="../ref/#DispersiveShallowWater.SummaryCallback"><code>SummaryCallback</code></a> provides performance profiling information at the end of a simulation. It tracks computational time spent in different parts of the code and memory allocations, giving insights into the computational efficiency of the simulation.</p><p>The callback automatically prints a detailed timing breakdown showing:</p><ul><li>Total simulation time and memory allocations</li><li>Time spent in different computational sections</li><li>Number of function calls and average execution time per call</li></ul><pre><code class="language-julia hljs">summary_callback = SummaryCallback()
sol = solve(ode, Tsit5(), callback = summary_callback)</code></pre><p>At the end of the simulation, the callback will display output similar to:</p><pre><code class="nohighlight hljs">───────────────────────────────────────────────────────────────────────────────────────────
              DispersiveSWE                       Time                    Allocations
                                         ───────────────────────   ────────────────────────
            Tot / % measured:                 440ms /  98.4%            867MiB /  99.9%

Section                          ncalls     time    %tot     avg     alloc    %tot      avg
───────────────────────────────────────────────────────────────────────────────────────────
rhs!                              1.62k    420ms   97.0%   258μs    866MiB  100.0%   546KiB
  solving elliptic system         1.62k    247ms   57.2%   152μs    357MiB   41.2%   225KiB
  assembling elliptic operator    1.62k    167ms   38.6%   103μs    509MiB   58.8%   321KiB
  hyperbolic terms                1.62k   3.49ms    0.8%  2.15μs     0.00B    0.0%    0.00B
  ~rhs!~                          1.62k   1.46ms    0.3%   902ns   1.55KiB    0.0%    0.98B
  source terms                    1.62k   42.0μs    0.0%  25.9ns     0.00B    0.0%    0.00B
analyze solution                      3   13.2ms    3.0%  4.39ms    147KiB    0.0%  49.1KiB
───────────────────────────────────────────────────────────────────────────────────────────</code></pre><h2 id="Analysis-Callback"><a class="docs-heading-anchor" href="#Analysis-Callback">Analysis Callback</a><a id="Analysis-Callback-1"></a><a class="docs-heading-anchor-permalink" href="#Analysis-Callback" title="Permalink"></a></h2><p>The <a href="../ref/#DispersiveShallowWater.AnalysisCallback"><code>AnalysisCallback</code></a> monitors solution quality and physical properties during the simulation. It computes error norms and tracks conservation of important physical quantities at specified time intervals.</p><p>First, let&#39;s set up a basic simulation using the BBM-BBM equations:</p><pre><code class="language-julia hljs">using DispersiveShallowWater, OrdinaryDiffEqTsit5

# Define the physical setup
equations = BBMBBMEquations1D(gravity = 9.81)

initial_condition = initial_condition_convergence_test

# Create mesh and solver
coordinates_min = -35.0
coordinates_max = 35.0
N = 512
mesh = Mesh1D(coordinates_min, coordinates_max, N)
accuracy_order = 8
solver = Solver(mesh, accuracy_order)

# Create semidiscretization
semi = Semidiscretization(mesh, equations, initial_condition, solver,
                          boundary_conditions = boundary_condition_periodic)</code></pre><p>The analysis callback computes <span>$L^2$</span> and <span>$L^\infty$</span> errors by comparing the numerical solution to the initial condition at time <span>$t$</span> (which can be the analytical solution, if available). Additional error types can be specified using the <code>extra_analysis_errors</code> parameter, and physical quantities can be monitored using <code>extra_analysis_integrals</code>.</p><p>The conservation error measures the temporal change of conserved quantities. For the BBM-BBM equations, important conserved quantities include the total water mass (integral of water height <code>h</code>), the total momentum (integral of <code>v</code> for flat bathymetry), and the <a href="../ref/#DispersiveShallowWater.entropy-Tuple{Any, AbstractShallowWaterEquations}"><code>entropy</code></a>. The specific form of the entropy varies between different equation systems. For the BBM-BBM equations, the entropy is:</p><p class="math-container">\[\mathcal E(t; \eta, v) = \frac{1}{2}\int_\Omega g\eta^2 + (\eta + D)v^2 \, dx\]</p><p>where <span>$\eta$</span> is the total water height and <span>$D$</span> is the still-water depth.</p><pre><code class="language-julia hljs">tspan = (0.0, 20.0)
ode = semidiscretize(semi, tspan)

analysis_callback = AnalysisCallback(semi; interval = 10,
                                     extra_analysis_errors = (:conservation_error,),
                                     extra_analysis_integrals = (waterheight_total,
                                                                 velocity, entropy),
                                     io = devnull)

saveat = range(tspan..., length = 100)
sol = solve(ode, Tsit5(), abstol = 1e-7, reltol = 1e-7,
            save_everystep = false, callback = analysis_callback, saveat = saveat)</code></pre><p>The recorded errors and integrals can be accessed as <code>NamedTuple</code>s using <a href="../ref/#DispersiveShallowWater.errors-Union{Tuple{SciMLBase.DiscreteCallback{Condition, Affect!}}, Tuple{Affect!}, Tuple{Condition}} where {Condition, Affect!&lt;:AnalysisCallback}"><code>errors(analysis_callback)</code></a> and <a href="../ref/#DispersiveShallowWater.integrals-Union{Tuple{SciMLBase.DiscreteCallback{Condition, Affect!}}, Tuple{Affect!}, Tuple{Condition}} where {Condition, Affect!&lt;:AnalysisCallback}"><code>integrals(analysis_callback)</code></a>.</p><p>The temporal evolution of monitored quantities can be visualized by plotting the analysis callback:</p><pre><code class="language-julia hljs">using Plots

plot(analysis_callback)</code></pre><p>More on different options for plotting the analysis callback can be found in the chapter <a href="../plotting/#plotting">Plotting Simulation Results</a>.</p><p><img src="../analysis_callback.png" alt="analysis callback"/></p><p>The plot shows that linear invariants such as the total water mass and total velocity are conserved exactly. However, nonlinear invariants such as the entropy may exhibit small growth over time. This occurs because standard time integration methods do not necessarily preserve nonlinear invariants, even when the spatial discretization is conservative.</p><p>For a fully discrete entropy-conservative method, see also the following section about relaxation and the <code>RelaxationCallback</code>.</p><h2 id="Relaxation-Callback"><a class="docs-heading-anchor" href="#Relaxation-Callback">Relaxation Callback</a><a id="Relaxation-Callback-1"></a><a class="docs-heading-anchor-permalink" href="#Relaxation-Callback" title="Permalink"></a></h2><p>To obtain entropy-conserving time-stepping schemes, <a href="https://github.com/NumericalMathematics/DispersiveShallowWater.jl">DispersiveShallowWater.jl</a> uses the relaxation method introduced in <sup class="footnote-reference"><a id="citeref-Ketcheson2019" href="#footnote-Ketcheson2019">[Ketcheson2019]</a></sup> and further developed in <sup class="footnote-reference"><a id="citeref-RanochaSayyariDalcinParsaniKetcheson2020" href="#footnote-RanochaSayyariDalcinParsaniKetcheson2020">[RanochaSayyariDalcinParsaniKetcheson2020]</a></sup>. The relaxation method is implemented as a <a href="../ref/#DispersiveShallowWater.RelaxationCallback"><code>RelaxationCallback</code></a>, which takes a function representing the conserved quantity as the keyword argument <code>invariant</code>. This callback modifies the time step to maintain conservation of a specified quantity.</p><h3 id="Entropy-Conserving-Time-Integration"><a class="docs-heading-anchor" href="#Entropy-Conserving-Time-Integration">Entropy-Conserving Time Integration</a><a id="Entropy-Conserving-Time-Integration-1"></a><a class="docs-heading-anchor-permalink" href="#Entropy-Conserving-Time-Integration" title="Permalink"></a></h3><p>To achieve exact conservation of the entropy, we add a relaxation callback to the simulation:</p><pre><code class="language-julia hljs">analysis_callback2 = AnalysisCallback(semi; interval = 10,
                                      extra_analysis_errors = (:conservation_error,),
                                      extra_analysis_integrals = (waterheight_total,
                                                                  velocity, entropy),
                                      io = devnull)
relaxation_callback = RelaxationCallback(invariant = entropy)

# Important: RelaxationCallback must come before AnalysisCallback
callbacks = CallbackSet(relaxation_callback, analysis_callback2)
sol = solve(ode, Tsit5(), abstol = 1e-7, reltol = 1e-7,
            save_everystep = false, callback = callbacks, saveat = saveat)</code></pre><div class="admonition is-info" id="Callback-Ordering-5c465d4218b5fc99"><header class="admonition-header">Callback Ordering<a class="admonition-anchor" href="#Callback-Ordering-5c465d4218b5fc99" title="Permalink"></a></header><div class="admonition-body"><p>When using both <code>RelaxationCallback</code> and <code>AnalysisCallback</code>, the relaxation callback must be placed first in the <code>CallbackSet</code>. This ensures that the analysis callback monitors the solution after the relaxation step has been applied.</p></div></div><p>The relaxation method modifies each time step by finding an optimal relaxation parameter that preserves the specified invariant exactly. This results in entropy conservation almost up to machine precision and therefore provides a fully discrete structure-preserving numerical scheme:</p><pre><code class="language-julia hljs">plot(analysis_callback2, ylims = (-4e-12, 4e-12))</code></pre><p><img src="../analysis_callback_relaxation.png" alt="analysis callback relaxation"/></p><h2 id="Relaxation"><a class="docs-heading-anchor" href="#Relaxation">Relaxation</a><a id="Relaxation-1"></a><a class="docs-heading-anchor-permalink" href="#Relaxation" title="Permalink"></a></h2><p>For a semidiscretization, which conserves a nonlinear invariant, the relaxation method conserves this nonlinear invariant up to machine precision also in the temporal discretization with minimal computational overhead. This can improve solution stability and accuracy, often reducing error growth over time from quadratic to linear.</p><p>The following comparison shows error growth with and without the relaxation method using the above simulation setup. For the comparison, it is important that we use a high accuracy order of our spatial discretization and sufficiently fine grid resolution. Otherwise, spatial discretization errors will dominate the total error, making it difficult to observe the improvements that relaxation provides to the temporal error behavior.</p><pre><code class="language-julia hljs">plot(analysis_callback2, what = (:errors,), exclude = (:conservation_error, :linf_error),
     label = &quot;L2 error with relaxation&quot;)
plot!(analysis_callback, what = (:errors,), exclude = (:conservation_error, :linf_error),
      label = &quot;L2 error without relaxation&quot;)</code></pre><p><img src="../error_growth_relaxation.png" alt="error growth relaxation"/></p><p>For additional information on relaxation, how it works, and why and when it is useful, see <a href="https://doi.org/10.1137/19M1263480">Ranocha et al. (2020)</a>.</p><h3 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h3><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-Ketcheson2019"><a class="tag is-link" href="#citeref-Ketcheson2019">Ketcheson2019</a>Ketcheson (2019): Relaxation Runge-Kutta Methods: Conservation and stability for Inner-Product Norms. <a href="https://doi.org/10.1137/19M1263662">DOI: 10.1137/19M1263662</a></li><li class="footnote" id="footnote-RanochaSayyariDalcinParsaniKetcheson2020"><a class="tag is-link" href="#citeref-RanochaSayyariDalcinParsaniKetcheson2020">RanochaSayyariDalcinParsaniKetcheson2020</a>Ranocha, Sayyari, Dalcin, Parsani, Ketcheson (2020): Relaxation Runge–Kutta Methods: Fully-Discrete Explicit Entropy-Stable Schemes for the Compressible Euler and Navier–Stokes Equations. <a href="https://doi.org/10.1137/19M1263480">DOI: 10.1137/19M1263480</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../solvers/">« Using Different Solvers</a><a class="docs-footer-nextpage" href="../plotting/">Plotting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 20 August 2025 10:27">Wednesday 20 August 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
